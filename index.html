<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>زيادة المتابعين والمهام</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    .task-list, .user-section {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    a {
      color: #0077cc;
      text-decoration: none;
    }
    input[type="text"] {
      padding: 8px;
      width: 100%;
      margin: 5px 0 15px 0;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    #message {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
      color: red;
    }
    #pointsDisplay {
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>زيادة المتابعين والمهام</h1>

  <section class="user-section">
    <label for="instaUser">أدخل يوزر إنستجرام الخاص بك:</label>
    <input type="text" id="instaUser" placeholder="مثلاً: your_username" />
    <div id="pointsDisplay">النقاط الحالية: 0</div>
    <div id="message"></div>
  </section>

  <section class="task-list">
    <h2>المهام المتاحة للجميع</h2>
    <table id="tasksTable">
      <thead>
        <tr>
          <th>اليوزر (A)</th>
          <th>النقاط (B)</th>
          <th>الترويج (C)</th>
          <th>الرابط (D)</th>
          <th>إكمال المهمة</th>
        </tr>
      </thead>
      <tbody>
        <!-- المهام ستُحمّل من جدول جوجل -->
      </tbody>
    </table>
  </section>

<script>
  const spreadsheetId = "1Kc03RybK-YMMQeeABrScFgpzuL5ENhOymZGR-lSKWag";
  const sheetName = "Sheet1";
  const gsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${sheetName}&tq=select+A,B,C,D`;

  const tasksTableBody = document.querySelector("#tasksTable tbody");
  const instaUserInput = document.getElementById("instaUser");
  const pointsDisplay = document.getElementById("pointsDisplay");
  const messageDiv = document.getElementById("message");

  let tasksData = [];
  let userPoints = 0;
  let completedTasks = new Set(); // لتخزين المهام التي أكملها المستخدم (محليًا)

  function loadTasks() {
    fetch(gsheetUrl)
      .then(res => res.text())
      .then(dataText => {
        const jsonText = dataText.match(/google\.visualization\.Query\.setResponse\((.*)\);/)[1];
        const json = JSON.parse(jsonText);
        tasksData = json.table.rows || [];

        displayTasks(tasksData);
      })
      .catch(err => {
        console.error("خطأ في جلب المهام:", err);
        tasksTableBody.innerHTML = `<tr><td colspan="5">فشل تحميل المهام</td></tr>`;
      });
  }

  function displayTasks(rows) {
    tasksTableBody.innerHTML = "";

    rows.forEach((row, idx) => {
      const username = row.c[0]?.v || "";
      const points = row.c[1]?.v || 0;
      const promotion = row.c[2]?.v || "";
      const link = row.c[3]?.v || "";

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${username}</td>
        <td>${points}</td>
        <td>${promotion}</td>
        <td>${link ? `<a href="${link}" target="_blank" rel="noopener noreferrer">رابط المهمة</a>` : "-"}</td>
        <td><button data-idx="${idx}">إكمال</button></td>
      `;

      tasksTableBody.appendChild(tr);
    });

    document.querySelectorAll("#tasksTable button").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = btn.getAttribute("data-idx");
        completeTask(idx);
      });
    });
  }

  function updateUserPoints() {
    pointsDisplay.textContent = `النقاط الحالية: ${userPoints}`;
  }

  // تحديث النقاط حسب اليوزر عند تغييره
  instaUserInput.addEventListener("input", () => {
    userPoints = 0;
    completedTasks.clear();
    updateUserPoints();
    messageDiv.textContent = "";
  });

  function completeTask(taskIdx) {
    const usernameInput = instaUserInput.value.trim();
    if (!usernameInput) {
      messageDiv.textContent = "يرجى إدخال اسم المستخدم أولاً.";
      messageDiv.style.color = "red";
      return;
    }

    if (completedTasks.has(taskIdx)) {
      messageDiv.textContent = "لقد أكملت هذه المهمة من قبل.";
      messageDiv.style.color = "orange";
      return;
    }

    const task = tasksData[taskIdx];
    if (!task) return;

    const taskPoints = parseInt(task.c[1]?.v || 0);

    userPoints += taskPoints;
    completedTasks.add(taskIdx);

    updateUserPoints();

    messageDiv.textContent = `تم إكمال المهمة وكسبت ${taskPoints} نقطة!`;
    messageDiv.style.color = "green";
  }

  loadTasks();
</script>

</body>
</html>